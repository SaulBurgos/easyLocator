/*!
 * jQuery easyLocator v2.0
 * https://github.com/SaulBurgos/easyLocator
 *
 * Copyright Saul Burgos
 * http://saulburgos.com/
 *
 * Date: 31/08/2016
 */

!function(t){var o=this,e=t.Deferred();this.easyLocatorMethods={locations:[],onEvents:e.promise(),locationActive:null,selectorMapList:".locatorMap_list",htmlPlug:'<div class="locatorMap_loader">Loading...</div><div id="mapContainer_map" class="locatorMap_map"></div><div class="locatorMap_listContainer locatorMap_list--desktop js-locatorMap_listContainerDesktop"><div class="locatorMap_listContainer_filter">  <input class="locatorMap_listContainer_filter_input" type="text" placeholder="filter.."></div><ul class="locatorMap_list js-locatorMap_list"></ul></div><div class="locatorMap_listContainer locatorMap_list--mobile js-locatorMap_listContainerMobile" style="display:none"><div class="locatorMap_list_close js-locatorMap_list_Close"><i class="fa fa-chevron-down"></i></div><ul class="locatorMap_list"></ul></div><div class="locatorMap_template"></div>',options:{mapContainer:void 0,map:void 0,mapOptions:void 0,isAPIloaded:!1,myLocations:[],openInfowindowAfterClick:!1,showListOnDesktop:!0,showListOnMobile:!0,itemListActiveCustomClass:"",infoWindowCustomClass:"",contentTemplate:"",useMarkerCluster:!1,mapType:void 0,centerMapOnLocation:!0,markerClustererOptions:{maxZoom:12}},loadScripts:function(t){this.showHideLoader("show");var e="https://maps.googleapis.com/maps/api/js?libraries=places&signed_in=true&language=en&callback=window.easyLocatorMethods.loadMap",a=document.createElement("link");a.rel="stylesheet",a.href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css";var i=document.getElementsByTagName("link")[0];if(i.parentNode.insertBefore(a,i),"object"==typeof google&&"object"==typeof google.maps)o.easyLocatorMethods.options.isAPIloaded=!0,this.loadMap();else{"undefined"!=typeof this.options.apiKey&&(e="https://maps.googleapis.com/maps/api/js?libraries=places&signed_in=true&language=en&key="+this.options.apiKey+"&callback=window.easyLocatorMethods.loadMap");var s=document.createElement("script");s.type="text/javascript",s.src=e,document.body.appendChild(s)}},loadMap:function(){o.easyLocatorMethods.triggerEvent({eventName:"loadingMap",data:{}}),this.options.isAPIloaded=!0;var t;t="undefined"==typeof this.options.mapOptions?{zoom:8,center:new google.maps.LatLng(-34.397,150.644),mapTypeId:google.maps.MapTypeId.ROADMAP}:this.options.mapOptions,this.options.map=new google.maps.Map(document.getElementById("mapContainer_map"),t),this.options.map.controls[google.maps.ControlPosition.TOP_CENTER].push(this.createButtonList()),this.options.markerClusterer=new MarkerClusterer(this.options.map,null,this.options.markerClustererOptions),google.maps.event.addListenerOnce(this.options.map,"idle",function(){return o.easyLocatorMethods.triggerEvent({eventName:"mapLoaded",data:{}}),"undefined"!=typeof o.easyLocatorMethods.options.spreadsheetId?void o.easyLocatorMethods.getJsonData():void(o.easyLocatorMethods.options.myLocations.length>0&&o.easyLocatorMethods.loadMyLocations())}),""==this.options.contentTemplate&&(this.options.infoWindow=new google.maps.InfoWindow({maxWidth:400}),google.maps.event.addListener(this.options.infoWindow,"closeclick",function(){o.easyLocatorMethods.removeAllIconsActive(),o.easyLocatorMethods.triggerEvent({eventName:"infoWindowClosed",data:{}})}))},createEvents:function(){t(".js-locatorMap_list_Close").on("click",function(){t(".js-locatorMap_listContainerMobile").slideToggle("fast")}),t(".locatorMap_listContainer_filter_input").change(function(){o.easyLocatorMethods.filterList(this)}).keyup(function(){o.easyLocatorMethods.filterList(this)})},filterList:function(o){var e=t(o).val();""!=e?(t(".js-locatorMap_list").find('.locatorMap_list_item_title:not(:contains_("'+e+'"))').parent().slideUp(),t(".js-locatorMap_list").find('.locatorMap_list_item_title:contains_("'+e+'")').parent().slideDown()):t(".js-locatorMap_list").find("li").slideDown()},createButtonList:function(e){if(o.easyLocatorMethods.options.showListOnMobile){var a=t.parseHTML('<div id="locatorMap_openList"><i class="fa fa-list"></i></div>')[0];return google.maps.event.addDomListener(a,"click",function(){t(".js-locatorMap_listContainerMobile").slideToggle("fast")}),a}},showHideLoader:function(o){"show"==o?t(".locatorMap_loader").show():t(".locatorMap_loader").hide()},getJsonData:function(){var t=document.createElement("script");t.type="text/javascript",t.src="https://spreadsheets.google.com/feeds/list/"+this.options.spreadsheetId+"/od6/public/values?hl=en_US&alt=json&callback=window.easyLocatorMethods.successGetJsonData",t.async=!0,document.body.appendChild(t)},getContentITemList:function(t,o,e){"undefined"!=typeof e.gsx$iconmarker&&(e.iconMarker=e.gsx$iconmarker.$t);var a='<li class="locatorMap_list_item" data-indexarray="'+t+'" data-isactive="false"><span class="ocatorMap_list_itemPlaceHolder"></span> <span class="locatorMap_list_item_title">'+o+"</span></li>";return(""==e.iconMarker||"undefined"==typeof e.iconMarker)&&(a=a.replace('<span class="ocatorMap_list_itemPlaceHolder"></span>','<i class="locatorMap_list_item_icon fa fa-map-marker"></i>')),""!=e.iconMarker&&(a=a.replace('<span class="ocatorMap_list_itemPlaceHolder"></span>','<img src="'+e.iconMarker+'" class="locatorMap_list_item_iconImage" />')),a},successGetJsonData:function(e){var a=t(this.selectorMapList);a.empty();for(var i="",s=0;s<e.feed.entry.length;s++){var n=e.feed.entry[s];i+=this.getContentITemList(s,n.gsx$title.$t,n);var r=new google.maps.Marker({position:new google.maps.LatLng(n.gsx$lat.$t,n.gsx$lng.$t),map:this.options.map,title:n.gsx$title.$t});""!=n.gsx$iconmarker.$t&&r.setOptions({icon:{url:n.gsx$iconmarker.$t,scaledSize:new google.maps.Size(32,32)}}),this.locations.push({index:s,title:n.gsx$title.$t,description:n.gsx$description.$t,image:n.gsx$image.$t,link:n.gsx$link.$t,iconMarker:n.gsx$iconmarker.$t,iconMarkerActive:n.gsx$iconmarkeractive.$t,marker:r,active:!1}),this.options.useMarkerCluster&&this.options.markerClusterer.addMarker(r)}this.loadItemsOnList(a,i),o.easyLocatorMethods.triggerEvent({eventName:"getDataDone",data:{}})},loadMyLocations:function(){var e=t(this.selectorMapList);e.empty();for(var a="",i=0;i<this.options.myLocations.length;i++){var s=this.options.myLocations[i];a+=this.getContentITemList(i,s.title,s);var n=new google.maps.Marker({position:new google.maps.LatLng(s.lat,s.lng),map:this.options.map,title:s.title});"undefined"!=typeof s.iconMarker&&n.setOptions({icon:{url:s.iconMarker,scaledSize:new google.maps.Size(32,32)}}),this.locations.push({index:i,title:s.title,description:s.description,image:s.image,link:s.link,iconMarker:s.iconMarker,iconMarkerActive:s.iconMarkerActive,marker:n,active:!1}),this.options.useMarkerCluster&&this.options.markerClusterer.addMarker(n)}this.loadItemsOnList(e,a),o.easyLocatorMethods.triggerEvent({eventName:"getDataDone",data:{}})},loadItemsOnList:function(t,o){t.html(o),this.attachEventLocations(),this.showHideLoader("hide"),this.options.centerMapOnLocation&&this.centerMapOnLocations()},centerMapOnLocations:function(){for(var t=new google.maps.LatLngBounds,o=0;o<this.locations.length;o++)t.extend(this.locations[o].marker.getPosition());this.options.map.fitBounds(t)},attachEventLocations:function(){function e(e){google.maps.event.addListener(e.marker,"click",function(){""==o.easyLocatorMethods.options.contentTemplate?o.easyLocatorMethods.openInfoWindow(e):o.easyLocatorMethods.openTemplate(e),o.easyLocatorMethods.setIconsActiveOnItem({elementClicked:t(".locatorMap_list_item")[e.index],location:e}),o.easyLocatorMethods.triggerEvent({eventName:"locationClicked",data:e})})}for(var a=0;a<this.locations.length;a++)e(this.locations[a]);t(".locatorMap_list_item").on("click",function(){o.easyLocatorMethods.removeAllIconsActive(),t(".locatorMap_list_item").removeClass(o.easyLocatorMethods.options.itemListActiveCustomClass);var e=o.easyLocatorMethods.locations[t(this).attr("data-indexarray")];o.easyLocatorMethods.options.map.setCenter(e.marker.getPosition()),o.easyLocatorMethods.options.openInfowindowAfterClick&&""==o.easyLocatorMethods.options.contentTemplate&&o.easyLocatorMethods.openInfoWindow(e),""!=o.easyLocatorMethods.options.contentTemplate&&o.easyLocatorMethods.openTemplate(e),t(window).width()<=768&&t(".js-locatorMap_listContainerMobile").slideToggle("fast"),""!=o.easyLocatorMethods.options.itemListActiveCustomClass&&t(this).addClass(o.easyLocatorMethods.options.itemListActiveCustomClass),o.easyLocatorMethods.setIconsActiveOnItem({elementClicked:this,location:e}),o.easyLocatorMethods.triggerEvent({eventName:"locationClicked",data:e})}),t(this.options.mapContainer).on("click",".locatorMap_template_close",function(){o.easyLocatorMethods.closeTemplate()})},setIconsActiveOnItem:function(o){t(o.elementClicked).addClass("locatorMap_list_item--active"),t(o.elementClicked).attr("data-isactive","true"),o.location.active=!0,""!=o.location.iconMarkerActive&&"undefined"!=typeof o.location.iconMarkerActive&&(t(o.elementClicked).find("img").attr("src",o.location.iconMarkerActive),o.location.marker.setOptions({icon:{url:o.location.iconMarkerActive,scaledSize:new google.maps.Size(42,42)}}))},removeAllIconsActive:function(){t(".locatorMap_list_item[data-isactive=true]").each(function(e){var a=o.easyLocatorMethods.locations[t(this).attr("data-indexarray")];t(this).removeClass("locatorMap_list_item--active"),a.active=!1,""!=a.iconMarker&&"undefined"!=typeof a.iconMarker?(t(this).find("img").attr("src",a.iconMarker),a.marker.setIcon({url:a.iconMarker,scaledSize:new google.maps.Size(32,32)})):a.marker.setIcon(null)})},openTemplate:function(o){var e=_.template(this.options.contentTemplate),a=t(this.options.mapContainer).find(".locatorMap_template");a.html(e(o)),a.show()},triggerEvent:function(t){e.notify(t)},closeTemplate:function(){t(this.options.mapContainer).find(".locatorMap_template").hide(),o.easyLocatorMethods.triggerEvent({eventName:"templateClosed",data:{}})},openInfoWindow:function(t){var e="",a="";this.locationActive=t,""!=t.link&&(e='<p><a href="'+t.link+'" target="_blank">View</a></p>'),""!=t.image&&(a='<img src="'+t.image+'" class="locatorMap_responsiveImg"/>');var i='<div id="locatorMap_contentInfoWindow" class="'+o.easyLocatorMethods.options.infoWindowCustomClass+' ">'+a+'<p class="locatorMap_contentInfoWindow_title"><b>'+t.title+"</b></p><p>"+t.description+"</p>"+e+"</div>";this.options.infoWindow.setContent(i),this.options.infoWindow.open(this.options.map,t.marker)},getMapInstance:function(){return this.options.map},cleanMap:function(){for(var t=0;t<this.locations.length;t++)this.locations[t].marker.setMap(null);this.options.useMarkerCluster&&this.options.markerClusterer.clearMarkers()},rebuild:function(e){this.cleanMap(),t(this.selectorMapList).empty(),this.locations=[];for(var a="",i=0;i<e.length;i++){var s,n=e[i];a+=this.getContentITemList(i,n.title,n),s=n.marker?n.marker.getPosition():new google.maps.LatLng(n.lat,n.lng);var r=new google.maps.Marker({position:s,map:this.options.map,title:n.title});"undefined"!=typeof n.iconMarker&&""!=n.iconMarker&&r.setOptions({icon:{url:n.iconMarker,scaledSize:new google.maps.Size(32,32)}}),this.locations.push({index:i,title:n.title,description:n.description,image:n.image,link:n.link,iconMarker:n.iconMarker,iconMarkerActive:n.iconMarkerActive,marker:r,active:!1}),this.options.useMarkerCluster&&this.options.markerClusterer.addMarker(r)}this.loadItemsOnList(t(this.selectorMapList),a),o.easyLocatorMethods.triggerEvent({eventName:"rebuildDone",data:{}})}},t.fn.easyLocator=function(e){return jQuery.expr[":"].contains_=function(t,o,e){return(t.textContent||t.innerText||"").toUpperCase().indexOf(e[3].toUpperCase())>=0},this.addClass("locatorMap"),this.html(o.easyLocatorMethods.htmlPlug),o.easyLocatorMethods.options=t.extend(o.easyLocatorMethods.options,e),o.easyLocatorMethods.options.mapContainer=this,o.easyLocatorMethods.loadScripts(),o.easyLocatorMethods.createEvents(),o.easyLocatorMethods.options.showListOnDesktop||(t("#mapContainer_map").addClass("locatorMap_map--fullWidth"),t(".js-locatorMap_listContainerDesktop").hide()),o.easyLocatorMethods}}(jQuery);